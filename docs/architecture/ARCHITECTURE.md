# Tepora Project - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä»•æ§˜æ›¸

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 5.0
**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 4.0 (Alpha) (v0.4.0)
**æœ€çµ‚æ›´æ–°æ—¥**: 2026-02-15
**å¯¾è±¡**: Rust Backend + React Frontend

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#1-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#3-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
4. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](#4-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ )
5. [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#5-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£-rust)
6. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#6-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
7. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#7-ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
8. [APIä»•æ§˜](#8-apiä»•æ§˜)
9. [è¨­å®šã‚·ã‚¹ãƒ†ãƒ ](#9-è¨­å®šã‚·ã‚¹ãƒ†ãƒ )
10. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#10-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
11. [å“è³ªä¿è¨¼](#11-å“è³ªä¿è¨¼)
12. [è£œè¶³](#12-è£œè¶³)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ãƒ“ã‚¸ãƒ§ãƒ³

**"Local-First, Privacy-Centric AI Agent"**

Teporaã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Œçµã—ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’æœ€å„ªå…ˆã«ã—ãŸãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚é«˜åº¦ãªè¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ  (EM-LLM) ã¨è‡ªå¾‹çš„ãªã‚¿ã‚¹ã‚¯å®Ÿè¡Œèƒ½åŠ›ã‚’æŒã¡ãªãŒã‚‰ã€å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¾å­˜ã—ãªã„å®‰å¿ƒæ„Ÿã‚’æä¾›ã—ã¾ã™ã€‚

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå

**Teporaï¼ˆãƒ†ãƒãƒ©ï¼‰** - ã‚¤ã‚¿ãƒªã‚¢èªã®"Tepore"ï¼ˆæ¸©ã‹ã¿ï¼‰ã¨"ora"ï¼ˆç¾åœ¨ï¼‰ã‚’çµ„ã¿åˆã‚ã›ãŸé€ èªã€‚ç´…èŒ¶ãƒ»å–«èŒ¶åº—ã‚’ãƒ†ãƒ¼ãƒã«ã—ãŸã€æ¸©ã‹ã¿ã®ã‚ã‚‹AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚

### ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

| ã‚³ãƒ³ã‚»ãƒ—ãƒˆ                   | èª¬æ˜                                                            |
| ---------------------------- | --------------------------------------------------------------- |
| **Local First**        | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æœ€å„ªå…ˆã€‚ãƒ‡ãƒ¼ã‚¿ã‚‚æ¨è«–ã‚‚ã™ã¹ã¦ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµ            |
| **Rust Backend**       | Pythonç‰ˆã‹ã‚‰å®Œå…¨ç§»è¡Œã€‚å®‰å…¨æ€§ã€ä¸¦è¡Œæ€§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€å¤§åŒ–      |
| **Graph Architecture** | `petgraph` ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ€è€ƒã‚’ãƒ¢ãƒ‡ãƒ«åŒ– |
| **Modern Frontend**    | React 19 + Tauri v2 ã«ã‚ˆã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ©ã‚¤ã‚¯ãªæ“ä½œæ„Ÿ              |

### ä¸»è¦æ©Ÿèƒ½

| æ©Ÿèƒ½                      | èª¬æ˜                                                               |
| ------------------------- | ------------------------------------------------------------------ |
| **3ã¤ã®å‹•ä½œãƒ¢ãƒ¼ãƒ‰** | Chatï¼ˆAIã¨ã®è‡ªç”±å¯¾è©±ï¼‰/ Searchï¼ˆWebæ¤œç´¢+RAGï¼‰/ Agentï¼ˆãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰ |
| **EM-LLM**          | ICLR 2025æ¡æŠè«–æ–‡ã«åŸºã¥ãã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ                     |
| **MCPå¯¾å¿œ**         | Model Context Protocolã«ã‚ˆã‚‹æ‹¡å¼µå¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ                |
| **RAG**             | Retrieval-Augmented Generationã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ‹¡å¼µ               |
| **ãƒšãƒ«ã‚½ãƒŠ**        | è¤‡æ•°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒšãƒ«ã‚½ãƒŠã®åˆ‡ã‚Šæ›¿ãˆ                             |

---

## 2. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Teporaã¯ **Tauri** ã‚’ç”¨ã„ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚UIã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã¯åˆ†é›¢ã•ã‚Œã¦ãŠã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆä¸Šã®HTTP/WebSocketã§é€šä¿¡ã—ã¾ã™ã€‚

### å…¨ä½“æ§‹æˆå›³

```mermaid
graph TD
    User[ãƒ¦ãƒ¼ã‚¶ãƒ¼] <--> Frontend[Frontend - Tauri/React]
  
    subgraph "Desktop Boundary (User PC)"
        Frontend <-->|WebSocket / HTTP| Backend[Backend - Rust/Axum]
      
        subgraph Backend Components
            API[Axum API Layer]
            State[AppState Arc]
            Pipeline[WorkerPipeline]
            Graph[Tepora Graph Engine]
            LLM[LLM Service]
            MCP[MCP Manager]
            EAM[ExclusiveAgentManager]
        end
      
        Backend <-->|Model Loading| GGUF[GGUF Models]
        Backend <-->|Persistence| SQL[SQLite DB - History + RAG]
      
        MCP <--> ExtTools[External Tools - Node/Python]
    end
  
    Frontend -.->|Shell Command| Sidecar[Sidecar Process Management]
```

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚

```mermaid
graph TD
    Main[main.rs] --> API[api.rs]
    Main --> WS[ws.rs]
    Main --> State[state.rs]
  
    API --> Graph[graph/]
    WS --> Graph
  
    Graph --> Nodes[nodes/]
    Graph --> LLM[llama.rs]
    Graph --> Tools[tooling.rs]
    Graph --> Search[search.rs]
  
    State --> Config[config.rs]
    State --> History[history.rs]
    State --> MCP[mcp.rs]
    State --> Models[models.rs]
  
    MCP --> McpRegistry[mcp_registry.rs]
    MCP --> McpInstaller[mcp_installer.rs]
```

> [!IMPORTANT]
> **ä¾å­˜ãƒ«ãƒ¼ãƒ«**: ä¸‹ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¸Šä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãªã„ã€‚`config` ã¨ `state` ã¯åŸºç›¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦å…¨ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£éšå±¤

| å±¤                           | æŠ€è¡“                     | å½¹å‰²                                       |
| ---------------------------- | ------------------------ | ------------------------------------------ |
| **ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³** | Tauri + React            | UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ               |
| **çŠ¶æ…‹ç®¡ç†**           | Zustand + TanStack Query | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ + ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| **é€šä¿¡**               | WebSocket + REST         | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ–¹å‘é€šä¿¡ + API               |
| **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**   | Axum                     | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°               |
| **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯**   | petgraph + GraphRuntime  | ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¶å¾¡           |
| **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰** | WorkerPipeline           | ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒªãƒƒãƒãƒ¡ãƒ³ãƒˆ   |
| **ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹**     | sqlx + SQLite            | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ« + ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ (in-process) |
| **æ¨è«–ã‚¨ãƒ³ã‚¸ãƒ³**       | llama.cpp                | LLMæ¨è«–å‡¦ç†                                |

---

## 3. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

| ã‚«ãƒ†ã‚´ãƒª                    | æŠ€è¡“                | ç”¨é€”                       |
| --------------------------- | ------------------- | -------------------------- |
| **è¨€èª**              | Rust (2021 edition) | ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯               |
| **Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯** | Axum                | HTTP/WebSocket ã‚µãƒ¼ãƒãƒ¼    |
| **éåŒæœŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ **  | Tokio               | éåŒæœŸå‡¦ç†                 |
| **ã‚°ãƒ©ãƒ•ã‚¨ãƒ³ã‚¸ãƒ³**    | petgraph            | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**      | sqlx (SQLite)       | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– |
| **RAGã‚¹ãƒˆã‚¢**         | SQLite + ndarray    | ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ (in-process)  |
| **ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—**      | ndarray             | ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—         |
| **ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**      | serde / serde_json  | JSONå‡¦ç†                   |
| **HTTP Client**       | reqwest             | å¤–éƒ¨APIå‘¼ã³å‡ºã—            |

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

| ã‚«ãƒ†ã‚´ãƒª                 | æŠ€è¡“           | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€”                    |
| ------------------------ | -------------- | ---------- | ----------------------- |
| **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯** | React          | 19.x       | UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ        |
| **è¨€èª**           | TypeScript     | 5.x        | å‹å®‰å…¨æ€§                |
| **ã‚¢ãƒ—ãƒªã‚·ã‚§ãƒ«**   | Tauri          | 2.x        | ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªåŒ–    |
| **çŠ¶æ…‹ç®¡ç†**       | Zustand        | -          | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹        |
| **ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ** | TanStack Query | 5.x        | ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**   | Tailwind CSS   | 4.x        | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£CSS       |
| **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**   | React Router   | 7.x        | SPA routing             |
| **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**   | Vite           | 7.x        | é«˜é€Ÿãƒ“ãƒ«ãƒ‰              |

### AIãƒ¢ãƒ‡ãƒ«

| ã‚«ãƒ†ã‚´ãƒª             | ãƒ¢ãƒ‡ãƒ«ä¾‹                                  | ç”¨é€”              | æ¨å¥¨ã‚µã‚¤ã‚º       |
| -------------------- | ----------------------------------------- | ----------------- | ---------------- |
| **Text Model** | Gemma 3n E2B/4B, Ministral 3B, Phi-4 Mini | å¯¾è©±/ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | 2B - 4B (IQ4_XS) |
| **Embedding**  | EmbeddingGemma                            | ãƒ™ã‚¯ãƒˆãƒ«åŸ‹ã‚è¾¼ã¿  | 300M (Q8_0)      |

---

## 4. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ

```
Tepora_Project/
â”œâ”€â”€ Tepora-app/                 # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“
â”‚   â”œâ”€â”€ backend-rs/             # Rust ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
â”‚   â””â”€â”€ frontend/               # React ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”œâ”€â”€ docs/                       # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ architecture/           # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆï¼ˆæœ¬æ›¸ï¼‰
â”‚   â”œâ”€â”€ guides/                 # é–‹ç™ºã‚¬ã‚¤ãƒ‰
â”‚   â””â”€â”€ legacy/                 # æ—§Pythonç‰ˆè³‡æ–™
â”œâ”€â”€ scripts/                    # ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ Taskfile.yml                # ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼
â””â”€â”€ README.md
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹é€  (`Tepora-app/backend-rs/`)

```
backend-rs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                 # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ api.rs                  # REST API ãƒ«ãƒ¼ãƒˆå®šç¾©
â”‚   â”œâ”€â”€ ws.rs                   # WebSocket ãƒãƒ³ãƒ‰ãƒ©
â”‚   â”œâ”€â”€ state.rs                # AppState (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹)
â”‚   â”œâ”€â”€ config.rs               # è¨­å®šç®¡ç† (ConfigService, AppPaths)
â”‚   â”‚
â”‚   â”œâ”€â”€ graph/                  # ========== ã‚°ãƒ©ãƒ•ã‚¨ãƒ³ã‚¸ãƒ³ ==========
â”‚   â”‚   â”œâ”€â”€ mod.rs              # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¬é–‹
â”‚   â”‚   â”œâ”€â”€ runtime.rs          # GraphRuntime (å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³)
â”‚   â”‚   â”œâ”€â”€ builder.rs          # GraphBuilder (æ§‹ç¯‰ãƒ˜ãƒ«ãƒ‘ãƒ¼)
â”‚   â”‚   â”œâ”€â”€ state.rs            # AgentState å®šç¾©
â”‚   â”‚   â”œâ”€â”€ node.rs             # Node ãƒˆãƒ¬ã‚¤ãƒˆå®šç¾©
â”‚   â”‚   â””â”€â”€ nodes/              # ãƒãƒ¼ãƒ‰å®Ÿè£…
â”‚   â”‚       â”œâ”€â”€ chat.rs         # ChatNode (ç›´æ¥å¯¾è©±)
â”‚   â”‚       â”œâ”€â”€ search.rs       # SearchNode (æ¤œç´¢+è¦ç´„)
â”‚   â”‚       â”œâ”€â”€ search_agentic.rs # AgenticSearchNode (æ·±å±¤æ¤œç´¢) [v4.0]
â”‚   â”‚       â”œâ”€â”€ thinking.rs     # ThinkingNode (CoT)
â”‚   â”‚       â”œâ”€â”€ supervisor.rs   # SupervisorNode (ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
â”‚   â”‚       â”œâ”€â”€ planner.rs      # PlannerNode (è¨ˆç”»ç«‹æ¡ˆ)
â”‚   â”‚       â”œâ”€â”€ agent_executor.rs # AgentExecutor (ReActãƒ«ãƒ¼ãƒ—)
â”‚   â”‚       â”œâ”€â”€ synthesizer.rs  # SynthesizerNode (æœ€çµ‚å¿œç­”ç”Ÿæˆ)
â”‚   â”‚       â”œâ”€â”€ router.rs       # RouterNode (ãƒ¢ãƒ¼ãƒ‰åˆ†å²)
â”‚   â”‚       â””â”€â”€ tool.rs         # ToolNode (ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/                  # ========== ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç®¡ç† ==========
â”‚   â”‚   â”œâ”€â”€ exclusive_manager.rs # ExclusiveAgentManager [v4.0]
â”‚   â”‚   â”œâ”€â”€ runtime.rs          # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
â”‚   â”‚   â”œâ”€â”€ modes.rs            # RequestedAgentMode
â”‚   â”‚   â”œâ”€â”€ planner.rs          # ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ policy.rs           # ãƒ„ãƒ¼ãƒ«ãƒãƒªã‚·ãƒ¼
â”‚   â”‚   â””â”€â”€ instructions.rs     # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ context/                # ========== ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ ==========
â”‚   â”‚   â”œâ”€â”€ pipeline.rs         # ContextPipeline (ãƒ¬ã‚¬ã‚·ãƒ¼ + v4 bridge)
â”‚   â”‚   â”œâ”€â”€ pipeline_context.rs # PipelineContext (v4.0 æ§‹é€ ä½“) [v4.0]
â”‚   â”‚   â”œâ”€â”€ worker.rs           # ContextWorker trait + WorkerPipeline [v4.0]
â”‚   â”‚   â”œâ”€â”€ workers/            # Worker å®Ÿè£…ç¾¤ [v4.0]
â”‚   â”‚   â”‚   â”œâ”€â”€ system_worker.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ persona_worker.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ memory_worker.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ tool_worker.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ search_worker.rs
â”‚   â”‚   â”‚   â””â”€â”€ rag_worker.rs
â”‚   â”‚   â”œâ”€â”€ prompt.rs           # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
â”‚   â”‚   â””â”€â”€ window.rs           # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ llama.rs                # LlamaService (æ¨è«–ã‚µãƒ¼ãƒãƒ¼ç®¡ç†)
â”‚   â”œâ”€â”€ mcp.rs                  # McpManager (MCPæ¥ç¶šç®¡ç†)
â”‚   â”œâ”€â”€ mcp_registry.rs         # MCPã‚µãƒ¼ãƒãƒ¼ã‚«ã‚¿ãƒ­ã‚°
â”‚   â”œâ”€â”€ mcp_installer.rs        # MCPã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼
â”‚   â”œâ”€â”€ models.rs               # ModelManager (ãƒ¢ãƒ‡ãƒ«ç®¡ç†)
â”‚   â”œâ”€â”€ history.rs              # HistoryStore (ãƒãƒ£ãƒƒãƒˆå±¥æ­´)
â”‚   â”œâ”€â”€ search.rs               # æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆ
â”‚   â”œâ”€â”€ tooling.rs              # ToolManager (ãƒ„ãƒ¼ãƒ«ç®¡ç†)
â”‚   â”œâ”€â”€ security.rs             # èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ setup_state.rs          # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ em_llm/                 # EM-LLM (ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶)
â”‚   â”œâ”€â”€ memory/                 # ãƒ¡ãƒ¢ãƒªã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ rag/                    # RAG ã‚¨ãƒ³ã‚¸ãƒ³ (SqliteRagStore) [v4.0]
â”‚   â”‚   â”œâ”€â”€ store.rs            # RagStore trait
â”‚   â”‚   â””â”€â”€ sqlite.rs           # SqliteRagStore å®Ÿè£…
â”‚   â””â”€â”€ a2a/                    # Agent-to-Agent (å°†æ¥)
â”‚
â””â”€â”€ Cargo.toml
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹é€  (`Tepora-app/frontend/`)

```
frontend/
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tailwind.config.cjs
â”œâ”€â”€ public/
â”‚   â””â”€â”€ locales/                # ç¿»è¨³ (en, ja, es, zh)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.tsx                # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ App.tsx                 # ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ index.css               # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”œâ”€â”€ i18n.ts                 # å›½éš›åŒ–è¨­å®š
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/                 # ========== ZustandçŠ¶æ…‹ç®¡ç† ==========
â”‚   â”‚   â”œâ”€â”€ chatStore.ts        # ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°)
â”‚   â”‚   â”œâ”€â”€ sessionStore.ts     # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹
â”‚   â”‚   â””â”€â”€ websocketStore.ts   # WebSocketæ¥ç¶šçŠ¶æ…‹
â”‚   â”‚
â”‚   â”œâ”€â”€ features/               # ========== Feature-Sliced Design ==========
â”‚   â”‚   â”œâ”€â”€ chat/               # ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ settings/           # è¨­å®šç”»é¢
â”‚   â”‚   â”œâ”€â”€ session/            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”‚   â””â”€â”€ navigation/         # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚
â”‚   â”œâ”€â”€ components/             # å…±æœ‰UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ hooks/                  # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ utils/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ types/                  # å‹å®šç¾©
â”‚   â””â”€â”€ context/                # React Context
â”‚
â””â”€â”€ src-tauri/                  # Tauriè¨­å®š
    â”œâ”€â”€ tauri.conf.json
    â””â”€â”€ binaries/               # ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒã‚¤ãƒŠãƒª
```

---

## 5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (Rust)

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ **Axum** ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸéåŒæœŸWebã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚

### 5.1 AppState (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹)

`Arc<AppState>` ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚Œã€å…¨APIãƒãƒ³ãƒ‰ãƒ©ã¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/state.rs`

```rust
pub struct AppState {
    pub paths: Arc<AppPaths>,        // ãƒ‘ã‚¹è¨­å®š
    pub config: ConfigService,       // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ã
    pub session_token: SessionToken, // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³
    pub history: HistoryStore,       // SQLiteã¸ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¢ã‚¯ã‚»ã‚¹
    pub llama: LlamaService,         // æ¨è«–ã‚µãƒ¼ãƒãƒ¼ç®¡ç†
    pub mcp: McpManager,             // MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç®¡ç†
    pub mcp_registry: McpRegistry,   // MCPã‚µãƒ¼ãƒãƒ¼ã‚«ã‚¿ãƒ­ã‚°
    pub models: ModelManager,        // ãƒ¢ãƒ‡ãƒ«ç®¡ç†
    pub setup: SetupState,           // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹
    pub started_at: DateTime<Utc>,   // èµ·å‹•æ™‚åˆ»
}
```

### 5.2 ã‚°ãƒ©ãƒ•ã‚¨ãƒ³ã‚¸ãƒ³ (`src/graph/`)

Pythonç‰ˆ LangGraph ã®æ¦‚å¿µã‚’ Rust ãƒã‚¤ãƒ†ã‚£ãƒ–ãª `petgraph` ã§å†å®Ÿè£…ã—ã¾ã—ãŸã€‚

#### GraphRuntime

ä»»æ„ã® `Node` å®Ÿè£…ã‚’ã¤ãªãåˆã‚ã›ã€çŠ¶æ…‹é·ç§»ã‚’ç®¡ç†ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/graph/runtime.rs`

```rust
pub struct GraphRuntime {
    graph: DiGraph<Box<dyn Node>, EdgeCondition>,
    name_to_index: HashMap<String, NodeIndex>,
    entry_node: Option<String>,
    max_steps: usize,
}
```

**EdgeCondition (é·ç§»æ¡ä»¶)**:

| æ¡ä»¶                                   | èª¬æ˜                           |
| -------------------------------------- | ------------------------------ |
| `EdgeCondition::Always`              | ç„¡æ¡ä»¶é·ç§»ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒƒã‚¸ï¼‰ |
| `EdgeCondition::OnCondition(String)` | ãƒãƒ¼ãƒ‰å‡ºåŠ›ã«åŸºã¥ãæ¡ä»¶åˆ†å²     |

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

| ãƒ¡ã‚½ãƒƒãƒ‰                                      | èª¬æ˜                 |
| --------------------------------------------- | -------------------- |
| `add_node(node)`                            | ãƒãƒ¼ãƒ‰ã‚’ã‚°ãƒ©ãƒ•ã«è¿½åŠ  |
| `add_edge(from, to)`                        | ç„¡æ¡ä»¶ã‚¨ãƒƒã‚¸ã‚’è¿½åŠ    |
| `add_conditional_edge(from, to, condition)` | æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã‚’è¿½åŠ  |
| `run(state, ctx)`                           | ã‚°ãƒ©ãƒ•ã‚’å®Ÿè¡Œ         |

#### AgentState (ã‚°ãƒ©ãƒ•çŠ¶æ…‹)

ã‚°ãƒ©ãƒ•å®Ÿè¡Œä¸­ã«å„ãƒãƒ¼ãƒ‰é–“ã§å…±æœ‰ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/graph/state.rs`

```rust
pub struct AgentState {
    // Session Identity
    pub session_id: String,
  
    // Core Messaging
    pub input: String,
    pub mode: Mode,                        // Chat | Search | Agent
    pub chat_history: Vec<ChatMessage>,
  
    // Hierarchical Agent Routing
    pub agent_id: Option<String>,          // UIé¸æŠã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    pub agent_mode: AgentMode,             // Low | High | Direct  [v4.0: Fastâ†’Low]
    pub selected_agent_id: Option<String>, // SupervisorãŒé¸æŠ
    pub supervisor_route: Option<SupervisorRoute>,
  
    // v4.0 Pipeline Context
    pub pipeline_context: Option<PipelineContext>,  // [v4.0] WorkerPipelineå‡ºåŠ›
  
    // Shared Context for Agents
    pub shared_context: SharedContext,     // Artifacts, Notes, Plans
  
    // Agent ReAct Loop State
    pub agent_scratchpad: Vec<ChatMessage>,
    pub agent_outcome: Option<String>,
  
    // Thinking Mode (CoT)
    pub thinking_enabled: bool,
    pub thought_process: Option<String>,
  
    // Search Mode State
    pub search_queries: Vec<String>,
    pub search_results: Option<Vec<SearchResult>>,
    pub search_attachments: Vec<Value>,
    pub skip_web_search: bool,
  
    // Final Output
    pub output: Option<String>,
    pub error: Option<String>,
}
```

**SharedContextæ§‹é€ **:

```rust
pub struct SharedContext {
    pub current_plan: Option<String>,      // PlannerãŒç”Ÿæˆã—ãŸè¨ˆç”»
    pub artifacts: Vec<Artifact>,          // ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã€æ¤œç´¢çµæœç­‰
    pub notes: Vec<String>,                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ã‚¹ã‚¯ãƒ©ãƒƒãƒãƒ‘ãƒƒãƒ‰
    pub professional_memory: Option<String>, // ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒ¡ãƒ¢ãƒª
}
```

#### ã‚°ãƒ©ãƒ•ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    START([START]) --> ROUTER{Mode Router}
  
    ROUTER -->|chat| THINK[ThinkingNode]
    THINK --> CHAT[ChatNode]
  
    ROUTER -->|"search (simple)"| SEARCH[SearchNode - Fast]
    ROUTER -->|"search (complex)"| AGENTIC["AgenticSearchNode - Deep Search [v4.0]"]
  
    ROUTER -->|agent| SUPERVISOR{Supervisor}
  
    SUPERVISOR -->|planner| PLANNER[PlannerNode]
    PLANNER --> SUPERVISOR
  
    SUPERVISOR -->|agent_id| AGENT_EXEC[AgentExecutor - ReAct Loop]
    AGENT_EXEC --> SYNTH[SynthesizerNode]
  
    CHAT --> END([END])
    SEARCH --> END
    AGENTIC --> END
    SYNTH --> END
```

### 5.3 ãƒãƒ¼ãƒ‰è©³ç´°

| ãƒãƒ¼ãƒ‰                   | ãƒ•ã‚¡ã‚¤ãƒ«                       | è²¬å‹™                                               |
| ------------------------ | ------------------------------ | -------------------------------------------------- |
| `RouterNode`           | `nodes/router.rs`            | å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦Chat/Search/Agentã«åˆ†å²        |
| `ThinkingNode`         | `nodes/thinking.rs`          | CoTï¼ˆChain of Thoughtï¼‰æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ç”Ÿæˆ            |
| `ChatNode`             | `nodes/chat.rs`              | LLMã«å¯¾ã—ã¦ç›´æ¥å¯¾è©±å¿œç­”ã‚’ç”Ÿæˆ                      |
| `SearchNode`           | `nodes/search.rs`            | Webæ¤œç´¢å®Ÿè¡Œ â†’ å†ãƒ©ãƒ³ã‚¯ â†’ LLMè¦ç´„ (Fastæ¤œç´¢)     |
| `AgenticSearchNode`   | `nodes/search_agentic.rs`    | 4æ®µéšãƒ‡ã‚£ãƒ¼ãƒ—ã‚µãƒ¼ãƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ **[v4.0]**         |
| `SupervisorNode`       | `nodes/supervisor.rs`        | éšå±¤çš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆPlanner or Agentï¼‰             |
| `PlannerNode`          | `nodes/planner.rs`           | ã‚¿ã‚¹ã‚¯è¨ˆç”»ã®ç«‹æ¡ˆ                                   |
| `AgentExecutor`        | `nodes/agent_executor.rs`    | ReActãƒ«ãƒ¼ãƒ—ã§ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ                          |
| `ToolNode`             | `nodes/tool.rs`              | å€‹åˆ¥ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œ                                   |
| `SynthesizerNode`      | `nodes/synthesizer.rs`       | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµæœã‹ã‚‰æœ€çµ‚å¿œç­”ã‚’ç”Ÿæˆ                 |

### 5.4 éšå±¤çš„ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

`agent` ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€éšå±¤çš„ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

```mermaid
graph TD
    subgraph "Supervisor Layer"
        SUP[SupervisorNode]
    end
  
    subgraph "Planning Layer"
        PLAN[PlannerNode]
    end
  
    subgraph "Execution Layer (ExclusiveAgentManager)"
        A1[Custom Agent 1]
        A2[Custom Agent 2]
        AN[Custom Agent N]
    end
  
    SUP -->|high mode| PLAN
    PLAN -->|plan| SUP
    SUP -->|low/direct mode| A1
    SUP --> A2
    SUP --> AN
```

**AgentMode (ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰)** [v4.0: `Fast` â†’ `Low` ã«ãƒªãƒãƒ¼ãƒ ]:

| ãƒ¢ãƒ¼ãƒ‰     | å‹•ä½œ                                                    |
| ---------- | ------------------------------------------------------- |
| `high`   | å¿…ãšPlannerã‚’çµŒç”±ã—ã¦è¨ˆç”»ã‚’ç«‹ã¦ã¦ã‹ã‚‰Custom Agentã‚’å®Ÿè¡Œ |
| `low`    | SupervisorãŒLLMã§åˆ¤æ–­ã€‚å˜ç´”â†’ç›´æ¥Agentã€è¤‡é›‘â†’Plannerã¸ |
| `direct` | æŒ‡å®šã•ã‚ŒãŸCustom Agentã«ç›´æ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°                |

> [!NOTE]
> `"fast"` ã¯ serde / parse ã§ãƒ¬ã‚¬ã‚·ãƒ¼ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦å¼•ãç¶šãå—ã‘å…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚

### 5.4.1 ExclusiveAgentManager [v4.0]

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/agent/exclusive_manager.rs`

ãƒ¬ã‚¬ã‚·ãƒ¼ã® `config.yml` å†… `custom_agents` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ›¿ã‚ã‚Šã€ç‹¬ç«‹ã—ãŸ `agents.yaml` ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã‚’ç®¡ç†ã—ã¾ã™ã€‚

| æ©Ÿèƒ½ | èª¬æ˜ |
| --- | --- |
| **CRUD + ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰** | `agents.yaml` ã®å‹•çš„èª­ã¿è¾¼ã¿ãƒ»æ›¸ãè¾¼ã¿ |
| **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè‡ªå‹•é¸æŠ** | ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚° + priority ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° |
| **ãƒ„ãƒ¼ãƒ«åè§£æ±º** | `web_search` â†’ `native_search`, `mcp:tool` â†’ `tool` |
| **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šç”Ÿæˆ** | `create_default_config()` ã§åˆæœŸ agents.yaml ã‚’ç”Ÿæˆ |

```yaml
# agents.yaml
agents:
  coder:
    name: "Code Assistant"
    description: "ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ç‰¹åŒ–"
    priority: 10
    tags: ["code", "programming"]
    tool_policy:
      allow_all: true
```

### 5.5 Agentic Search [v4.0]

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/graph/nodes/search_agentic.rs`

è¤‡é›‘ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦è‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹4æ®µéšãƒ‡ã‚£ãƒ¼ãƒ—ã‚µãƒ¼ãƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã™ã€‚

```mermaid
graph LR
    Q[Stage 1: Queryç”Ÿæˆ] --> S[Stage 2: ä¸¦åˆ—æ¤œç´¢+ãƒãƒ£ãƒ³ã‚¯é¸æŠ]
    S --> R[Stage 3: ãƒªã‚µãƒ¼ãƒãƒ¬ãƒãƒ¼ãƒˆ]
    R --> A[Stage 4: æœ€çµ‚åˆæˆ+ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°]
```

| ã‚¹ãƒ†ãƒ¼ã‚¸ | å‡¦ç†å†…å®¹ |
| --- | --- |
| **Queryç”Ÿæˆ** | LLMã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰3ã€œ5å€‹ã®ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆ |
| **ä¸¦åˆ—æ¤œç´¢+ãƒãƒ£ãƒ³ã‚¯é¸æŠ** | ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä¸¦åˆ—å®Ÿè¡Œã€çµæœã‚’é‡è¤‡æ’é™¤ãƒ»ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚° |
| **ãƒªã‚µãƒ¼ãƒãƒ¬ãƒãƒ¼ãƒˆ** | æ¤œç´¢çµæœã‚’LLMã§æ§‹é€ åŒ–ãƒ¬ãƒãƒ¼ãƒˆã«åˆæˆ |
| **æœ€çµ‚åˆæˆ** | ãƒ¬ãƒãƒ¼ãƒˆ+å…ƒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å›ç­”ã‚’ç”Ÿæˆ |

**ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®š** (`RouterNode` å†…):
- 200æ–‡å­—ä»¥ä¸Šã®å…¥åŠ› â†’ Agentic
- æ·±æ˜ã‚Šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º (`æ¯”è¼ƒ`, `åˆ†æ`, `è©³ç´°`, `é•ã„` ç­‰) â†’ Agentic
- `search_attachments` éç©º â†’ Agentic
- ãã‚Œä»¥å¤– â†’ Fast (SearchNode)

### 5.6 Thinking Mode (CoT)

è¤‡é›‘ãªæ¨è«–ã‚’å¿…è¦ã¨ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ **Thinking Mode** ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

- **å‹•ä½œ**: `ThinkingNode` ãŒæœ€çµ‚å›ç­”ã®å‰ã«å®Ÿè¡Œã•ã‚Œã€ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’ç”Ÿæˆ
- **çµ±åˆ**: ç”Ÿæˆã•ã‚ŒãŸæ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¯ `AgentState.thought_process` ã«ä¿å­˜
- **åˆ¶å¾¡**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `thinking_mode: true` ã§æœ‰åŠ¹åŒ–

### 5.7 ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (WorkerPipeline) [v4.0]

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/context/worker.rs`, `src/context/pipeline_context.rs`, `src/context/workers/`

v4.0 ã§ã¯ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ãª Worker ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§è¡Œã„ã¾ã™ã€‚

```mermaid
graph LR
    SYS[SystemWorker] --> PER[PersonaWorker]
    PER --> MEM[MemoryWorker]
    MEM --> TOOL[ToolWorker]
    TOOL --> SEARCH[SearchWorker]
    SEARCH --> RAG[RagWorker]
    RAG --> CTX[PipelineContext]
```

| Worker | è²¬å‹™ |
| --- | --- |
| `SystemWorker` | config ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ + ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ³¨å…¥ |
| `PersonaWorker` | ãƒšãƒ«ã‚½ãƒŠè¨­å®šã®æ³¨å…¥ (ãƒ¢ãƒ¼ãƒ‰é©æ ¼æ€§ãƒã‚§ãƒƒã‚¯ä»˜ã) |
| `MemoryWorker` | ä¼šè©±å±¥æ­´ + é•·æœŸè¨˜æ†¶ã®ãƒ­ãƒ¼ãƒ‰ |
| `ToolWorker` | åˆ©ç”¨å¯èƒ½ãƒ„ãƒ¼ãƒ«å®šç¾©ã®æ³¨å…¥ (Native + MCP) |
| `SearchWorker` | Webæ¤œç´¢å®Ÿè¡Œ + ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚° |
| `RagWorker` | RAGã‚¹ãƒˆã‚¢ã‹ã‚‰ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ |

**PipelineContext**: 1ã‚¿ãƒ¼ãƒ³ã®ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã™ã‚‹æ§‹é€ ä½“ã€‚`PipelineMode` (Chat, SearchFast, SearchAgentic, AgentHigh, AgentLow, AgentDirect) ã«åŸºã¥ã„ã¦ Worker ã®æœ‰åŠ¹/ç„¡åŠ¹ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚

### 5.8 LlamaService

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/llama.rs`

llama.cpp (llama-server) ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

```rust
pub struct LlamaService {
    paths: Arc<AppPaths>,
    process: Arc<Mutex<Option<Child>>>,
    port: AtomicU16,
}
```

**è²¬å‹™**:

- llama-serverãƒ—ãƒ­ã‚»ã‚¹ã®èµ·å‹•ãƒ»åœæ­¢
- GGUFãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
- Chat Completions API ã®æä¾›
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

### 5.9 MCP (Model Context Protocol)

Teporaã¯MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦å‹•ä½œã—ã€å¤–éƒ¨ã®MCPã‚µãƒ¼ãƒãƒ¼ï¼ˆ`git`, `filesystem` ãªã©ï¼‰ã¨æ¥ç¶šã—ã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/mcp.rs`, `src/mcp_registry.rs`, `src/mcp_installer.rs`

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ    | è²¬å‹™                                       |
| ----------------- | ------------------------------------------ |
| `McpManager`    | MCPæ¥ç¶šã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†                |
| `McpRegistry`   | åˆ©ç”¨å¯èƒ½ãªMCPã‚µãƒ¼ãƒãƒ¼ã®ã‚«ã‚¿ãƒ­ã‚°ç®¡ç†        |
| `mcp_installer` | `npm` / `pip` ã‚’ä½¿ã£ãŸè‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« |

### 5.10 EM-LLM (ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶)

ICLR 2025æ¡æŠè«–æ–‡ã€ŒEM-LLMã€ã®å®Ÿè£…ã€‚äººé–“ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶ã‚’LLMã§å†ç¾ã—ã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/em_llm/`

```mermaid
graph TB
    subgraph Storage["ä¿å­˜ãƒ•ãƒ­ãƒ¼"]
        Input[ä¼šè©±å…¥åŠ›] --> Segment[Surprise-based Segmentation]
        Segment --> Boundary[å¢ƒç•Œç²¾å¯†åŒ–]
        Boundary --> RepTokens[ä»£è¡¨ãƒˆãƒ¼ã‚¯ãƒ³é¸æŠ]
        RepTokens --> Embed[åŸ‹ã‚è¾¼ã¿è¨ˆç®—]
        Embed --> Store[SQLite RAGä¿å­˜]
    end
  
    subgraph Retrieval["æ¤œç´¢ãƒ•ãƒ­ãƒ¼"]
        Query[ã‚¯ã‚¨ãƒª] --> Stage1[Stage 1: Similarity-based]
        Query --> Stage2[Stage 2: Contiguity-based]
        Stage1 --> Merge[2æ®µéšçµ±åˆ]
        Stage2 --> Merge
        Merge --> Context[ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ³¨å…¥]
    end
```

### 5.11 RAG ã‚¹ãƒˆã‚¢ (SqliteRagStore) [v4.0]

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/rag/store.rs`, `src/rag/sqlite.rs`

v4.0 ã§ Qdrant ã‹ã‚‰ in-process SQLite ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã«ç§»è¡Œã—ã¾ã—ãŸã€‚

| æ©Ÿèƒ½ | èª¬æ˜ |
| --- | --- |
| **RagStore trait** | `ingest`, `query`, `delete_by_session`, `reindex` ã®4ãƒ¡ã‚½ãƒƒãƒ‰æŠ½è±¡åŒ– |
| **SqliteRagStore** | SQLite + `ndarray` ã«ã‚ˆã‚‹ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®— |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿** | ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° |

> [!IMPORTANT]
> `RagStore` trait ã«ã‚ˆã‚‹æŠ½è±¡åŒ–ã§ã€å°†æ¥ã® LanceDB ã‚„ Qdrant ã¸ã®ç§»è¡Œãƒ‘ã‚¹ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚

---

## 6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ãƒ¢ãƒ€ãƒ³ãªReactã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚’æ¡ç”¨ã—ã€**Feature-Sliced Design** ã®è»½é‡ç‰ˆæ§‹æˆã‚’å–ã£ã¦ã„ã¾ã™ã€‚

### 6.1 çŠ¶æ…‹ç®¡ç†

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ **Zustand** ã¨ **TanStack Query** ã‚’çµ„ã¿åˆã‚ã›ãŸçŠ¶æ…‹ç®¡ç†ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

```mermaid
graph TB
    subgraph "Zustand Stores (Client State)"
        Chat[chatStore - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸, ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°]
        Session[sessionStore - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§]
        WS[websocketStore - WebSocketæ¥ç¶š]
    end
  
    subgraph "TanStack Query (Server State)"
        Config[è¨­å®šãƒ‡ãƒ¼ã‚¿]
        MCPStatus[MCPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]
        Models[ãƒ¢ãƒ‡ãƒ«æƒ…å ±]
    end
  
    subgraph "Components"
        ChatInterface
        SessionHistory
        Settings
    end
  
    WS <-->|WebSocket| Backend
    Chat --> ChatInterface
    Session --> SessionHistory
    Config --> Settings
```

### 6.2 chatStore

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/stores/chatStore.ts`

```typescript
interface ChatState {
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  messages: Message[];
  isProcessing: boolean;
  error: string | null;
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡¦ç†è¡¨ç¤ºç”¨ï¼‰
  activityLog: AgentActivity[];
  
  // æ¤œç´¢çµæœ
  searchResults: SearchResult[];
  
  // ãƒ¡ãƒ¢ãƒªçµ±è¨ˆ
  memoryStats: MemoryStats | null;
  
  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡ï¼ˆå†…éƒ¨ï¼‰
  _streamBuffer: string;
  _streamMetadata: StreamingMetadata | null;
}

interface ChatActions {
  addMessage: (message: Message) => void;
  addUserMessage: (content: string, mode: ChatMode, attachments?: Attachment[]) => void;
  
  // Streaming
  handleStreamChunk: (content: string, metadata?: StreamingMetadata) => void;
  flushStreamBuffer: () => void;
  finalizeStream: () => void;
  
  // Activity
  updateActivity: (activity: AgentActivity) => void;
  clearActivityLog: () => void;
  
  reset: () => void;
}
```

**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯**:

- 50msé–“éš”ã§ãƒãƒƒãƒ•ã‚¡ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã—ã€UIã®å†æç”»å›æ•°ã‚’æŠ‘åˆ¶
- `ThinkingNode` ã‹ã‚‰ `ChatNode` ã¸ã®ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã‚‚ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€”åˆ‡ã‚Œã•ã›ãšã«çµåˆ

### 6.3 sessionStore

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/stores/sessionStore.ts`

```typescript
interface SessionState {
  sessions: Session[];
  currentSessionId: string | null;
  isLoading: boolean;
}

interface SessionActions {
  setSessions: (sessions: Session[]) => void;
  setCurrentSessionId: (id: string | null) => void;
  addSession: (session: Session) => void;
  updateSession: (id: string, updates: Partial<Session>) => void;
  removeSession: (id: string) => void;
}
```

### 6.4 websocketStore

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/stores/websocketStore.ts`

```typescript
interface WebSocketState {
  isConnected: boolean;
  isConnecting: boolean;
  error: string | null;
  socket: WebSocket | null;
  pendingToolConfirmation: ToolConfirmation | null;
}

interface WebSocketActions {
  connect: (url: string, token: string) => void;
  disconnect: () => void;
  sendMessage: (message: WebSocketMessage) => void;
  setSession: (sessionId: string) => void;
  stopGeneration: () => void;
  confirmTool: (requestId: string, approved: boolean) => void;
}
```

### 6.5 æ©Ÿèƒ½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (`features/`)

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª             | è²¬å‹™                                                   |
| ------------------------ | ------------------------------------------------------ |
| `features/chat/`       | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã€å…¥åŠ›ã‚¨ãƒªã‚¢ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° |
| `features/settings/`   | è¨­å®šãƒ‘ãƒãƒ«ã€ãƒ¢ãƒ‡ãƒ«ç®¡ç†ã€MCPç®¡ç†UI                      |
| `features/session/`    | ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ç®¡ç†                                     |
| `features/navigation/` | ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ                                 |

### 6.6 ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ    | è²¬å‹™                             |
| ----------------- | -------------------------------- |
| `ChatInterface` | ãƒãƒ£ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼å…¨ä½“ã®åˆ¶å¾¡         |
| `MessageList`   | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®è¡¨ç¤º           |
| `MessageBubble` | å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º             |
| `InputArea`     | ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼‹æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«       |
| `DialControl`   | Chat / Search / Agent ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ |
| `AgentStatus`   | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡¦ç†çŠ¶æ…‹ã®è¡¨ç¤º       |
| `SetupWizard`   | åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼           |

### 6.7 ã‚µã‚¤ãƒ‰ã‚«ãƒ¼é€£æº

Tauriã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«Rustãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’è‡ªå‹•çš„ã«å­ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ `localhost` ã®å‹•çš„ãƒãƒ¼ãƒˆã«å¯¾ã—ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™
- `src/utils/sidecar.ts` ãŒèµ·å‹•ãƒ—ãƒ­ã‚»ã‚¹ã¨ãƒãƒ¼ãƒˆæ¤œçŸ¥ã‚’æ‹…å½“

---

## 7. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant WebSocket
    participant Axum
    participant Graph
    participant LLM
  
    User->>Frontend: å…¥åŠ›é€ä¿¡
    Frontend->>WebSocket: message event
    WebSocket->>Axum: WebSocket message
    Axum->>Graph: run(state, ctx)
  
    Graph->>Graph: ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
    alt chat mode
        Graph->>LLM: Chat Completion
        LLM-->>Graph: stream response
    else search mode
        Graph->>Graph: Webæ¤œç´¢
        Graph->>Graph: RAGã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰
        Graph->>LLM: stream response
    else agent mode
        loop ReAct Loop
            Graph->>LLM: æ€è€ƒ
            Graph->>Graph: ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ
        end
    end
  
    loop Streaming
        Graph-->>Axum: chunk
        Axum-->>WebSocket: chunk event
        WebSocket-->>Frontend: handleStreamChunk()
        Frontend-->>User: è¡¨ç¤ºæ›´æ–°
    end
  
    Graph-->>Axum: done
    Axum-->>WebSocket: done event
    WebSocket-->>Frontend: finalizeStream()
```

---

## 8. APIä»•æ§˜

### 8.1 WebSocket

**æ¥ç¶š**:

```
ws://127.0.0.1:{port}/ws?token={session_token}
```

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼**:

| type                           | èª¬æ˜           | ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰                                                                    |
| ------------------------------ | -------------- | ----------------------------------------------------------------------------- |
| `message`                    | é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | `{ message, mode, sessionId, attachments?, skipWebSearch?, thinkingMode? }` |
| `stop`                       | å®Ÿè¡Œã‚­ãƒ£ãƒ³ã‚»ãƒ« | `{}`                                                                        |
| `get_stats`                  | ãƒ¡ãƒ¢ãƒªçµ±è¨ˆè¦æ±‚ | `{}`                                                                        |
| `set_session`                | ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡æ›¿ | `{ sessionId }`                                                             |
| `tool_confirmation_response` | ãƒ„ãƒ¼ãƒ«æ‰¿èªå¿œç­” | `{ requestId, approved }`                                                   |

**ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**:

| type                          | èª¬æ˜               | ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰                                      |
| ----------------------------- | ------------------ | ----------------------------------------------- |
| `chunk`                     | ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­” | `{ message, mode?, nodeId?, agentName? }`     |
| `status`                    | å‡¦ç†çŠ¶æ…‹æ›´æ–°       | `{ status, message }`                         |
| `activity`                  | ãƒãƒ¼ãƒ‰é€²æ—         | `{ data: { id, status, message } }`           |
| `history`                   | ãƒãƒ£ãƒƒãƒˆå±¥æ­´       | `{ messages: [...] }`                         |
| `search_results`            | æ¤œç´¢çµæœ           | `{ data: [...] }`                             |
| `tool_confirmation_request` | ãƒ„ãƒ¼ãƒ«æ‰¿èªè¦æ±‚     | `{ data: { requestId, toolName, toolArgs } }` |
| `done`                      | å‡¦ç†å®Œäº†           | `{}`                                          |
| `error`                     | ã‚¨ãƒ©ãƒ¼             | `{ message }`                                 |
| `stats`                     | ãƒ¡ãƒ¢ãƒªçµ±è¨ˆ         | `{ data: {...} }`                             |

### 8.2 REST API

#### åŸºæœ¬API

| ãƒ¡ã‚½ãƒƒãƒ‰  | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ           | èª¬æ˜                   |
| --------- | ------------------------ | ---------------------- |
| `GET`   | `/health`              | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯         |
| `GET`   | `/api/status`          | ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹     |
| `GET`   | `/api/config`          | è¨­å®šå–å¾—               |
| `POST`  | `/api/config`          | è¨­å®šæ›´æ–°ï¼ˆå…¨ä½“ï¼‰       |
| `PATCH` | `/api/config`          | è¨­å®šæ›´æ–°ï¼ˆéƒ¨åˆ†ï¼‰       |
| `GET`   | `/api/logs`            | ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§       |
| `GET`   | `/api/logs/{filename}` | ãƒ­ã‚°å†…å®¹å–å¾—           |
| `POST`  | `/api/shutdown`        | ã‚µãƒ¼ãƒãƒ¼ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ |

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³API

| ãƒ¡ã‚½ãƒƒãƒ‰   | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                  | èª¬æ˜               |
| ---------- | ------------------------------- | ------------------ |
| `GET`    | `/api/sessions`               | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§     |
| `POST`   | `/api/sessions`               | æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| `GET`    | `/api/sessions/{id}`          | ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°     |
| `PATCH`  | `/api/sessions/{id}`          | ã‚»ãƒƒã‚·ãƒ§ãƒ³åæ›´æ–°   |
| `DELETE` | `/api/sessions/{id}`          | ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤     |
| `GET`    | `/api/sessions/{id}/messages` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´å–å¾— |

#### MCP API

| ãƒ¡ã‚½ãƒƒãƒ‰   | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                      | èª¬æ˜                               |
| ---------- | ----------------------------------- | ---------------------------------- |
| `GET`    | `/api/mcp/status`                 | æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹                     |
| `GET`    | `/api/mcp/config`                 | MCPè¨­å®šå–å¾—                        |
| `POST`   | `/api/mcp/config`                 | MCPè¨­å®šæ›´æ–°                        |
| `GET`    | `/api/mcp/store`                  | ãƒ¬ã‚¸ã‚¹ãƒˆãƒªï¼ˆåˆ©ç”¨å¯èƒ½ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ï¼‰ |
| `GET`    | `/api/mcp/policy`                 | æ¥ç¶šãƒãƒªã‚·ãƒ¼                       |
| `PATCH`  | `/api/mcp/policy`                 | ãƒãƒªã‚·ãƒ¼æ›´æ–°                       |
| `POST`   | `/api/mcp/install/preview`        | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼             |
| `POST`   | `/api/mcp/install/confirm`        | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª                   |
| `POST`   | `/api/mcp/servers/{name}/enable`  | ã‚µãƒ¼ãƒãƒ¼æœ‰åŠ¹åŒ–                     |
| `POST`   | `/api/mcp/servers/{name}/disable` | ã‚µãƒ¼ãƒãƒ¼ç„¡åŠ¹åŒ–                     |
| `DELETE` | `/api/mcp/servers/{name}`         | ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤                       |

#### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—API

| ãƒ¡ã‚½ãƒƒãƒ‰   | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                | èª¬æ˜                       |
| ---------- | ----------------------------- | -------------------------- |
| `POST`   | `/api/setup/init`           | ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åˆæœŸåŒ–         |
| `POST`   | `/api/setup/preflight`      | äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆå®¹é‡ãƒ»æ¨©é™ï¼‰ |
| `GET`    | `/api/setup/requirements`   | è¦ä»¶ãƒã‚§ãƒƒã‚¯               |
| `GET`    | `/api/setup/default-models` | æ¨å¥¨ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ           |
| `POST`   | `/api/setup/run`            | ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹           |
| `GET`    | `/api/setup/progress`       | é€²æ—ç¢ºèª                   |
| `POST`   | `/api/setup/finish`         | ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†           |
| `GET`    | `/api/setup/models`         | åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«ä¸€è¦§         |
| `POST`   | `/api/setup/model/download` | ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰         |
| `DELETE` | `/api/setup/model/{id}`     | ãƒ¢ãƒ‡ãƒ«å‰Šé™¤                 |

---

## 9. è¨­å®šã‚·ã‚¹ãƒ†ãƒ 

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```mermaid
graph TB
    subgraph Runtime["ãƒ©ãƒ³ã‚¿ã‚¤ãƒ è¨­å®š"]
        ConfigYml[config.yml - ãƒ¡ã‚¤ãƒ³è¨­å®š]
        McpJson[mcp_tools_config.json - MCPæ¥ç¶šè¨­å®š]
    end
  
    subgraph Defaults["ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®šç¾©"]
        ConfigRs[src/config.rs - Rustã‚¹ã‚­ãƒ¼ãƒ]
        SeedJson[mcp_seed.json - MCPã‚µãƒ¼ãƒãƒ¼ã‚«ã‚¿ãƒ­ã‚°]
    end
  
    ConfigRs -->|ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤| ConfigYml
    SeedJson -->|ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã‚³ãƒ”ãƒ¼| McpJson
```

### config.yml ä¸»è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³

```yaml
app:
  max_input_length: 10000
  graph_recursion_limit: 50
  tool_execution_timeout: 120
  tool_approval_timeout: 300
  web_fetch_max_chars: 6000
  language: "ja"

server:
  host: "127.0.0.1"

tools:
  google_search_api_key: "YOUR_KEY"
  google_search_engine_id: "YOUR_CX"
  bing_api_key: "YOUR_KEY"
  brave_api_key: "YOUR_KEY"

privacy:
  allow_web_search: false
  redact_pii: true

llm:
  loader: "llama_cpp"
  health_check_timeout: 60

models_gguf:
  gemma_3n:
    path: "models/gemma-3n-E4B-it-IQ4_XS.gguf"
    port: 8088
    n_ctx: 8192
    n_gpu_layers: -1

em_llm:
  surprise_gamma: 1.0
  total_retrieved_events: 4

characters:
  bunny_girl:
    name: "Bunny Girl"
    system_prompt: "..."
```

> [!NOTE]
> v4.0 ã§ã¯ `custom_agents` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éæ¨å¥¨ã§ã™ã€‚ä»£ã‚ã‚Šã« `agents.yaml` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### å®Ÿè¡Œæ™‚ãƒ‡ãƒ¼ã‚¿é…ç½®

```
USER_DATA_DIR/
â”œâ”€â”€ config.yml              # ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
â”œâ”€â”€ tepora_core.db          # SQLite: ãƒãƒ£ãƒƒãƒˆå±¥æ­´ + RAGãƒ™ã‚¯ãƒˆãƒ«
â”œâ”€â”€ logs/                   # ã‚¢ãƒ—ãƒªãƒ­ã‚°
â””â”€â”€ config/
    â”œâ”€â”€ mcp_tools_config.json   # MCPæ¥ç¶šè¨­å®š
    â””â”€â”€ agents.yaml             # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾© [v4.0]
```

**OSåˆ¥ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**:

- Windows: `%LOCALAPPDATA%\Tepora`
- macOS: `~/Library/Application Support/Tepora`
- Linux: `~/.local/share/tepora`

---

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### èªè¨¼

| å¯¾è±¡                 | æ–¹å¼                       | èª¬æ˜                    |
| -------------------- | -------------------------- | ----------------------- |
| **REST API**   | `x-api-key` ãƒ˜ãƒƒãƒ€ãƒ¼     | æ©Ÿå¯†æ“ä½œã«å¿…é ˆ          |
| **WebSocket**  | ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `token` | æ¥ç¶šæ™‚ã«èªè¨¼            |
| **Originæ¤œè¨¼** | Allowlist                  | WebSocketã®Originã‚’æ¤œè¨¼ |

> [!NOTE]
> `TEPORA_ENV=development` ã®å ´åˆã€ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

### MCPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

| æ©Ÿèƒ½                           | èª¬æ˜                                                      |
| ------------------------------ | --------------------------------------------------------- |
| **2æ®µéšã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**    | preview â†’ confirm ã®2æ®µéšãƒ•ãƒ­ãƒ¼                          |
| **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç„¡åŠ¹**       | æ–°è¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹çŠ¶æ…‹            |
| **æ¥ç¶šãƒãƒªã‚·ãƒ¼**         | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `LOCAL_ONLY`ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼/stdioã®ã¿ï¼‰ |
| **ãƒ„ãƒ¼ãƒ«æ‰¿èª**           | MCPãƒ„ãƒ¼ãƒ«ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆå›ä½¿ç”¨æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãŒå¿…è¦       |
| **å±é™ºã‚³ãƒãƒ³ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯** | `sudo` ç­‰ã®å±é™ºã‚³ãƒãƒ³ãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯                       |

### ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·

| æ©Ÿèƒ½                       | èª¬æ˜                                   |
| -------------------------- | -------------------------------------- |
| **PIIä¿è­·**          | å¤–éƒ¨é€šä¿¡å‰ã«å€‹äººæƒ…å ±ã‚’è‡ªå‹•ãƒªãƒ€ã‚¯ã‚·ãƒ§ãƒ³ |
| **ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†**     | å…¨LLMå‡¦ç†ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œçµ              |
| **ãƒ­ã‚°ãƒªãƒ€ã‚¯ã‚·ãƒ§ãƒ³** | ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚‚PIIã‚’å‰Šé™¤            |

### ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

| æ©Ÿèƒ½                     | èª¬æ˜                                              |
| ------------------------ | ------------------------------------------------- |
| **Allowlist**      | è¨±å¯ã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒª/ã‚ªãƒ¼ãƒŠãƒ¼ã‹ã‚‰ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ |
| **ãƒªãƒ“ã‚¸ãƒ§ãƒ³å›ºå®š** | ç‰¹å®šãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šï¼ˆã‚¿ãƒ³ãƒ‘ãƒªãƒ³ã‚°é˜²æ­¢ï¼‰          |
| **SHA256æ¤œè¨¼**     | æä¾›æ™‚ã¯ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼ã‚’å®Ÿè¡Œ                        |
| **æœªç™»éŒ²è­¦å‘Š**     | Allowlistå¤–ã¯è­¦å‘Š + åŒæ„ã‚’å¿…é ˆåŒ–                  |

---

## 11. å“è³ªä¿è¨¼

### å“è³ªã‚²ãƒ¼ãƒˆæ§‹æˆ

1. **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º (Pre-commit)**

   - ã‚³ãƒŸãƒƒãƒˆæ™‚ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Lintã€åŸºæœ¬æ¤œè¨¼ã‚’è‡ªå‹•å®Ÿè¡Œ
2. **æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º (Task Runner)**

   - `task quality`: å…¨ä½“ã®å“è³ªãƒã‚§ãƒƒã‚¯
   - `task quality:fix`: è‡ªå‹•ä¿®æ­£ã‚’å«ã‚€ãƒã‚§ãƒƒã‚¯
3. **CI/CD (GitHub Actions)**

   - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŠã‚ˆã³ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å³æ ¼ãªæ¤œè¨¼

### æ¡ç”¨ãƒ„ãƒ¼ãƒ«

| é ˜åŸŸ               | ãƒ„ãƒ¼ãƒ«           | ç›®çš„                            |
| ------------------ | ---------------- | ------------------------------- |
| **Backend**  | cargo clippy     | Rustã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æ            |
| **Backend**  | cargo fmt        | ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ              |
| **Backend**  | cargo test       | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ                  |
| **Frontend** | Biome            | é«˜é€ŸLint/ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ           |
| **Frontend** | TypeScript (tsc) | å‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯                |
| **Security** | cargo audit      | Rustä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³    |
| **Security** | npm audit        | Node.jsä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ |

### é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

```bash
# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰èµ·å‹• (Frontend + Sidecar)
task dev

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã¿é–‹ç™ºèµ·å‹• (Watch mode)
task dev:backend

# å“è³ªãƒã‚§ãƒƒã‚¯ (Format, Lint, Test)
task quality
```

---

## 12. è£œè¶³

### Pythonç‰ˆã‹ã‚‰Rustç‰ˆã¸ã®ä¸»ãªå¤‰æ›´ç‚¹

| é …ç›®                        | Pythonç‰ˆ     | Rustç‰ˆ (v4.0)                |
| --------------------------- | ------------ | ---------------------------- |
| **è¨€èª**              | Python 3.10+ | Rust 2021                    |
| **Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯** | FastAPI      | Axum                         |
| **ã‚°ãƒ©ãƒ•ã‚¨ãƒ³ã‚¸ãƒ³**    | LangGraph    | petgraph (è‡ªå‰å®Ÿè£…)          |
| **LLMçµ±åˆ**           | LangChain    | ç›´æ¥HTTP (llama.cpp API)     |
| **ãƒ™ã‚¯ãƒˆãƒ«DB**        | ChromaDB     | SQLite + ndarray (in-process)|
| **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰**  | æ‰‹å‹•æ§‹ç¯‰     | WorkerPipeline (v4.0)        |
| **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**    | uv / pip     | Cargo                        |
| **ãƒã‚¤ãƒŠãƒªé…å¸ƒ**      | PyInstaller  | ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒŠãƒª           |

### ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

- **A2A Protocol**: Agent-to-Agenté€šä¿¡æ©Ÿèƒ½
- **WorkerPipeline å®Œå…¨çµ±åˆ**: å…¨ãƒãƒ¼ãƒ‰ã§ v4.0 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½¿ç”¨
- **é«˜æ©Ÿèƒ½ãƒ™ã‚¯ãƒˆãƒ«DBã¸ã®ç§»è¡Œ**: RagStore trait çµŒç”±ã§ LanceDB ã‚„ Qdrant ã¸ã®ç§»è¡Œã‚’æ¤œè¨

---

*æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ Tepora Project ã®æŠ€è¡“ä»•æ§˜ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚*
