# プロジェクト徹底批判的レビューレポート

**日付**: 2025-12-26
**対象**: Tepora Project (Beta v2.0)
**レビュワー**: Antigravity (AI Agent)

## 1. 概要 (Executive Summary)

本レポートは、Teporaプロジェクトに対して実施した徹底的なコードおよびアーキテクチャの監査結果です。
全体として、**最新技術（React 19, LangGraph, MCP）を野心的に採用している点は評価できますが、その反面、プロダクション品質に達していない「脆さ」と「セキュリティリスク」が散見されます。**

特に、**機密情報の扱いの甘さ**、**バックエンドの関心事の分離不足**、および**フロントエンドのブリーディングエッジな依存関係**は、将来的な負債となる可能性が高いです。

---

## 2. 構造と構成 (Structure & Configuration)

### 2.1. 依存関係管理の不整合
- **問題点**: `README.md` では `uv` の使用を推奨している一方で、`Taskfile.yml` は依然として `pip` を使用しています。また、`backend/pyproject.toml` には `tool.uv` のセクションがありますが、不完全です。
- **リスク**: 開発環境のセットアップ手順が二重管理されており、新規開発者が混乱する原因となります。`uv` の高速な解決機能を活かしきれていません。
- **推奨**: `Taskfile.yml` のコマンドを全て `uv` ベースに統一し、`pip` への依存を排除すべきです。

### 2.2. パス解決の脆弱性
- **問題点**: `backend/src/core/config/loader.py` 内の `_find_project_root` メソッドにおいて、`Path(__file__).resolve().parents[3]` という相対パス依存の実装があります。
- **リスク**: ディレクトリ構成を変更した瞬間にシステム全体が破損します。「決定的」とコメントされていますが、実際には非常に脆いです。
- **推奨**: 環境変数 `TEPORA_ROOT` を必須とするか、より堅牢な主要ファイル（例: `pyproject.toml`）の探索ロジックを導入すべきです。

---

## 3. バックエンド (Python / FastAPI)

### 3.1. セキュリティ設計の甘さ
- **問題点 (API Key)**: `schema.py` において `security: api_key` のデフォルト値が `None` となっています。これは、明示的に設定しない限り、APIが認証なしでアクセス可能になる可能性があることを示唆しています（ルート実装で `Depends(get_api_key)` は使われていますが、検証ロジックがザルであれば意味がありません）。
- **問題点 (機密情報の隠蔽)**: `routes.py` における `_redact_sensitive_values` メソッドは、再帰的に辞書を走査して特定のキーワード（api_key, secretなど）を探すという「手動」の実装です。
- **リスク**: 新しい機密キー名を追加した際に、このリストを更新し忘れると、機密情報がログやAPIレスポンスに平文で流出します。
- **推奨**: Pydanticの `SecretStr` 型を徹底して使用し、シリアライズ時に自動的に隠蔽される仕組みを採用すべきです。手動の隠蔽ロジックは廃止してください。

### 3.2. 関心事の分離 (Separation of Concerns) の欠如
- **問題点**: `backend/src/tepora_server/api/routes.py` に、設定ファイルの読み込み、マージ、分割（config.yml と secrets.yaml）、編集といった**ビジネスロジックが直接記述されています**。
- **リスク**: APIルーターが肥大化し（Fat Controller）、テストが困難になります。また、CLIなど他のインターフェースから設定変更ロジックを再利用できません。
- **推奨**: `ConfigService` クラスを作成し、設定のI/Oやバリデーションロジックをルーターから切り出してください。

### 3.3. グローバル状態への依存
- **問題点**: `backend/src/core/memory/memory_system.py` が、インポート時に `config.CHROMA_DB_PATH` をデフォルト引数として解決しています。
- **リスク**: テスト時にDBパスをモックすることが困難になり、並列テスト実行時にデータベースの競合が発生する原因となります。
- **推奨**: デフォルト引数での設定値参照をやめ、依存性注入（Dependency Injection）パターンを徹底してください。

---

## 4. フロントエンド (React / TypeScript)

### 4.1. React 19 の早すぎる採用
- **問題点**: `package.json` によると `react: 19.2.1` を使用しています。React 19 はリリースされたばかりであり、エコシステム（サードパーティライブラリ）の対応が完全に追いついていません。
- **リスク**: 未知のバグや、ライブラリの非互換性（特に `useEffect` や `useRef` の挙動変更に関連するもの）に遭遇するリスクが高いです。
- **推奨**: プロダクション利用を想定するのであれば、安定版である 18.x 系に戻すか、すべての使用ライブラリの互換性を厳密に検証する必要があります。現状は「実験的」な構成と言わざるを得ません。

### 4.2. 初期化ロジックの脆弱性
- **問題点**: `App.tsx` の `useEffect` 内で、APIサーバーへの `fetch` を行っていますが、タイムアウト処理やリトライロジックが不十分です。
- **リスク**: バックエンドが起動していない、あるいは応答がない場合、フロントエンドは永遠に「Loading...」のままフリーズします。ユーザー体験として致命的です。
- **推奨**: 明示的なタイムアウト設定と、接続失敗時の「再試行ボタン」を含むエラー画面の実装が必須です。

### 4.3. 巨大なカスタムフック
- **問題点**: `useWebSocket.ts` が、接続管理、メッセージ解析、状態管理、バッファリングロジックの全てを担っており、400行を超えています。
- **リスク**: ロジックが複雑すぎて保守性が低く、バグの温床となります。
- **推奨**: `useSocketConnection`（接続管理）、`useMessageBuffer`（バッファリング）、`useChatState`（状態管理）のように、責務ごとにフックを分割すべきです。

### 4.4. アクセシビリティ (a11y) の欠如
- **問題点**: チャットメッセージが追加された際、スクリーンリーダーに通知するための `aria-live` 属性が使用されていません。また、ボタン類の `aria-label` も不十分です。
- **リスク**: 視覚障害を持つユーザーにとって、このアプリケーションは事実上使用不可能です。
- **推奨**: 新しいメッセージ通知用の `aria-live="polite"` 領域を設置し、全てのインタラクティブ要素に適切なラベルを付与してください。

---

## 5. 結論と提言

Teporaプロジェクトは、**「動くプロトタイプ」としては優秀ですが、「信頼できる製品」としては未熟**です。

### 短期的な優先事項（Must Fix）
1.  **機密情報管理の安全化**: `ConfigService` の導入と Pydantic `SecretStr` への移行。
2.  **起動プロセスの堅牢化**: フロントエンドの無限ロード問題の修正。
3.  **パス解決の修正**: 相対パス依存の排除。

### 中期的な改善事項（Should Fix）
1.  **フロントエンドのリファクタリング**: `useWebSocket` の分割とエラーハンドリング強化。
2.  **React バージョンの再考**: 安定性を重視するなら v18 へのダウングレードを検討。
3.  **テスト容易性の向上**: バックエンドのグローバル依存の排除。

このレポートが、Teporaをより強固なエージェントへと進化させる一助となることを願います。

以上
