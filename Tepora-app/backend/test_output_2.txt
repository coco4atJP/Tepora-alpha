============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.5.0 -- C:\Users\nekon\miniconda3\python.exe
cachedir: .pytest_cache
rootdir: E:\Tepora_Project\Tepora-app\backend
configfile: pyproject.toml
plugins: anyio-4.11.0, langsmith-0.5.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 73 items

tests/test_a2a.py::TestA2AProtocol::test_dict_conversion PASSED          [  1%]
tests/test_a2a.py::TestA2AProtocol::test_message_creation PASSED         [  2%]
tests/test_a2a.py::TestA2AProtocol::test_serialization PASSED            [  4%]
tests/test_api.py::test_health_check PASSED                              [  5%]
tests/test_api_extensions.py::test_get_config FAILED                     [  6%]
tests/test_api_extensions.py::test_get_config_redacts_sensitive_info PASSED [  8%]
tests/test_api_extensions.py::test_get_config_returns_empty_when_no_file PASSED [  9%]
tests/test_api_extensions.py::test_update_config PASSED                  [ 10%]
tests/test_api_extensions.py::test_update_config_validates_with_pydantic PASSED [ 12%]
tests/test_api_extensions.py::test_update_config_restores_redacted_values PASSED [ 13%]
tests/test_api_extensions.py::test_get_logs_list PASSED                  [ 15%]
tests/test_api_extensions.py::test_get_logs_no_auth_for_localhost PASSED [ 16%]
tests/test_api_extensions.py::test_get_log_content PASSED                [ 17%]
tests/test_api_extensions.py::test_log_traversal_attack PASSED           [ 19%]
tests/test_attachment_limit.py::TestAttachmentSizeLimit::test_attachment_within_limit PASSED [ 20%]
tests/test_attachment_limit.py::TestAttachmentSizeLimit::test_attachment_processing_logic PASSED [ 21%]
tests/test_config_schema.py::TestConfigSystem::test_settings_load_defaults FAILED [ 23%]
tests/test_config_schema.py::TestConfigSystem::test_settings_load_from_yaml_proxy PASSED [ 24%]
tests/test_config_schema.py::TestConfigSystem::test_env_var_override PASSED [ 26%]
tests/test_config_schema.py::TestConfigSystem::test_cors_origins PASSED  [ 27%]
tests/test_config_schema.py::TestConfigSystem::test_characters PASSED    [ 28%]
tests/test_config_schema.py::TestConfigSystem::test_pydantic_validation PASSED [ 30%]
tests/test_contract_ws.py::test_websocket_contract PASSED                [ 31%]
tests/test_llm_manager.py::TestLLMManager::test_cleanup PASSED           [ 32%]
tests/test_llm_manager.py::TestLLMManager::test_initialization PASSED    [ 34%]
tests/test_llm_manager.py::TestLLMManager::test_load_character_model_success PASSED [ 35%]
tests/test_llm_manager.py::TestLLMManager::test_load_embedding_model_success PASSED [ 36%]
tests/test_llm_manager.py::TestLLMManager::test_model_switching PASSED   [ 38%]
tests/test_llm_manager.py::TestMemorySystem::test_retrieve_handles_missing_distances PASSED [ 39%]
tests/test_llm_manager.py::TestMemorySystem::test_retrieve_handles_short_distance_list PASSED [ 41%]
tests/test_llm_manager.py::TestEMEventSegmenter::test_fallback_tokenizer_used_when_punkt_unavailable PASSED [ 42%]
tests/test_llm_manager.py::TestEMLLMIntegrator::test_process_logprobs_skips_invalid_entries PASSED [ 43%]
tests/test_llm_manager.py::TestAgentCoreRouting::test_route_defaults_to_direct_answer PASSED [ 45%]
tests/test_llm_manager.py::TestAgentCoreRouting::test_route_stats_commands PASSED [ 46%]
tests/test_memory_nodes.py::TestMemoryNodes::test_memory_retrieval_node_no_memory_system PASSED [ 47%]
tests/test_memory_nodes.py::TestMemoryNodes::test_memory_retrieval_node_with_memory PASSED [ 49%]
tests/test_memory_nodes.py::TestMemoryNodes::test_save_memory_node PASSED [ 50%]
tests/test_retrieval.py::TestEMTwoStageRetrieval::test_add_events PASSED [ 52%]
tests/test_retrieval.py::TestEMTwoStageRetrieval::test_deduplicate_events PASSED [ 53%]
tests/test_retrieval.py::TestEMTwoStageRetrieval::test_retrieve_relevant_events PASSED [ 54%]
tests/test_segmenter.py::TestEMEventSegmenter::test_calculate_surprise_from_logprobs PASSED [ 56%]
tests/test_segmenter.py::TestEMEventSegmenter::test_identify_event_boundaries PASSED [ 57%]
tests/test_segmenter.py::TestEMEventSegmenter::test_segment_text_into_events_semantic PASSED [ 58%]
tests/test_segmenter.py::TestEMEventSegmenter::test_segment_text_into_events_short_text PASSED [ 60%]
tests/test_setup_security.py::test_setup_endpoints_accessible_localhost PASSED [ 61%]
tests/test_setup_security.py::test_setup_download_accessible_localhost PASSED [ 63%]
tests/test_tool_manager.py::TestToolManager::test_aexecute_tool PASSED   [ 64%]
tests/test_tool_manager.py::TestToolManager::test_execute_tool PASSED    [ 65%]
tests/test_tool_manager.py::TestToolManager::test_get_tool PASSED        [ 67%]
tests/test_tool_manager.py::TestToolManager::test_initialize PASSED      [ 68%]
tests/test_ws_e2e.py::TestWebSocketConnection::test_websocket_connection PASSED [ 69%]
tests/test_ws_e2e.py::TestWebSocketConnection::test_websocket_disconnection PASSED [ 71%]
tests/test_ws_e2e.py::TestMessageProcessing::test_message_processing_flow PASSED [ 72%]
tests/test_ws_e2e.py::TestMessageProcessing::test_empty_message_ignored PASSED [ 73%]
tests/test_ws_e2e.py::TestMessageValidation::test_invalid_json PASSED    [ 75%]
tests/test_ws_e2e.py::TestMessageValidation::test_extra_fields_ignored PASSED [ 76%]
tests/test_ws_e2e.py::TestControlCommands::test_get_stats_command PASSED [ 78%]
tests/test_ws_e2e.py::TestControlCommands::test_stop_command PASSED      [ 79%]
tests/test_ws_e2e.py::TestModeHandling::test_different_modes[direct] PASSED [ 80%]
tests/test_ws_e2e.py::TestModeHandling::test_different_modes[search] PASSED [ 82%]
tests/test_ws_e2e.py::TestModeHandling::test_different_modes[agent] PASSED [ 83%]
tests/test_ws_e2e.py::TestAttachments::test_message_with_attachments PASSED [ 84%]
tests/test_ws_security.py::TestOriginValidation::test_no_origin_allowed PASSED [ 86%]
tests/test_ws_security.py::TestOriginValidation::test_tauri_origin_allowed PASSED [ 87%]
tests/test_ws_security.py::TestOriginValidation::test_localhost_origins_allowed PASSED [ 89%]
tests/test_ws_security.py::TestOriginValidation::test_external_origin_rejected PASSED [ 90%]
tests/test_ws_security.py::TestOriginValidation::test_partial_match_rejected PASSED [ 91%]
tests/test_ws_security.py::TestTokenValidation::test_development_mode_skips_validation PASSED [ 93%]
tests/test_ws_security.py::TestTokenValidation::test_production_mode_no_token_allowed PASSED [ 94%]
tests/test_ws_security.py::TestTokenValidation::test_valid_token_accepted PASSED [ 95%]
tests/test_ws_security.py::TestTokenValidation::test_invalid_token_rejected PASSED [ 97%]
tests/test_ws_security.py::TestAllowedOriginsList::test_tauri_origins_in_list PASSED [ 98%]
tests/test_ws_security.py::TestAllowedOriginsList::test_development_origins_in_list PASSED [100%]

================================== FAILURES ===================================
_______________________________ test_get_config _______________________________

client = <starlette.testclient.TestClient object at 0x000001597B165F90>
run_with_auth = None

    def test_get_config(client, run_with_auth):
        """Test retrieving configuration with redacted sensitive values."""
        mock_config = {"app": {"name": "Tepora Test"}, "llm": {"model": "gpt-4"}}
    
        mock_yaml = yaml.dump(mock_config)
    
        with patch("builtins.open", mock_open(read_data=mock_yaml)), \
             patch("pathlib.Path.exists", return_value=True):
    
            response = client.get("/api/config")
    
            assert response.status_code == 200
            # Config without sensitive keys should be unchanged
>           assert response.json() == mock_config
E           AssertionError: assert {'app': {'nam...el': 'gpt-4'}} == {'app': {'nam...el': 'gpt-4'}}
E             
E             Omitting 2 identical items, use -vv to show
E             Left contains 1 more item:
E             {'characters': {'bunny_girl': {'description': 'にこにこ笑ってちょっぴりいたずら好きなバニーガール姉さん。',
E                                            'model_config_name': None,
E                                            'name': 'マリナ',
E                                            'system_prompt': '<persona_definition>\n'...
E             
E             ...Full output truncated (213 lines hidden), use '-vv' to show

tests\test_api_extensions.py:59: AssertionError
----------------------------- Captured log setup ------------------------------
WARNING  src.core.app.startup_validator:startup_validator.py:76 [models_gguf.executor_model.path] Model file not found at: E:\Tepora_Project\Tepora-app\backend\models\granite-4.0-h-micro-IQ4_XS.gguf (Key: executor_model)
________________ TestConfigSystem.test_settings_load_defaults _________________

self = <test_config_schema.TestConfigSystem object at 0x000001597AE57750>

    def test_settings_load_defaults(self):
        """Test that settings load with defaults."""
        assert settings.app.max_input_length == 10000
>       assert settings.active_agent_profile == "bunny_girl"
E       AssertionError: assert 'ren' == 'bunny_girl'
E         
E         - bunny_girl
E         + ren

tests\test_config_schema.py:10: AssertionError
============================== warnings summary ===============================
tests/test_llm_manager.py: 2 warnings
tests/test_ws_e2e.py: 12 warnings
  E:\Tepora_Project\Tepora-app\backend\src\core\graph\core.py:150: UserWarning: The 'config' parameter should be typed as 'RunnableConfig' or 'RunnableConfig | None', not 'dict'. 
    workflow.add_node(GraphNodes.TOOL_NODE, self.unified_tool_executor_node)

tests/test_ws_e2e.py: 12 warnings
  E:\Tepora_Project\Tepora-app\backend\src\core\graph\em_llm_core.py:116: UserWarning: The 'config' parameter should be typed as 'RunnableConfig' or 'RunnableConfig | None', not 'dict'. 
    workflow.add_node(GraphNodes.TOOL_NODE, base_core.unified_tool_executor_node)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_api_extensions.py::test_get_config - AssertionError: assert...
FAILED tests/test_config_schema.py::TestConfigSystem::test_settings_load_defaults
================= 2 failed, 71 passed, 26 warnings in 46.54s ==================
